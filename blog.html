<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Hugh Thompson's Blog - Engineering projects, software development, and technical articles.">
    <meta name="keywords" content="Hugh Thompson, Blog, Engineering, Software Development, Projects, Technical Articles">
    <meta name="author" content="Hugh Thompson">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Hugh Thompson - Blog">
    <meta property="og:description" content="Engineering projects, software development, and technical articles.">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Hugh Thompson - Blog">
    <meta name="twitter:description" content="Engineering projects, software development, and technical articles.">
    
    <title>Hugh Thompson - Blog</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="navbar.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=mail" />
    <link rel="stylesheet" href="project-grid.css">
    <link rel="icon" href="src/favicon.png" type="image/x-icon">
</head>

<body>
    <header class="header" role="banner">
        <div class="progress-container">
            <div class="progress-bar" id="myBar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Page scroll progress"></div>
        </div>
    </header>
    <nav class="navbar" role="navigation" aria-label="Main navigation">
        <button class="menu-btn" onclick="onToggle()" aria-label="Toggle navigation menu" aria-expanded="false" id="menu-toggle">
            <div class="btn-line"></div>
            <div class="btn-line"></div>
            <div class="btn-line"></div>
        </button>
        <a href="index.html" class="logo menu-item">Hugh Thompson</a>
        <a href="blog.html" class="menu-item" aria-current="page">Blog</a>
        <a href="contact.html" class="menu-item">Contact</a>
    </nav>

    <main class="main-body">
        <h1>Blog</h1>
        
        <section class="search-section" aria-label="Search and filter">
            <div class="search-container">
                <input type="text" id="search" placeholder="Search posts..." aria-label="Search posts">
                <button id="clear-search" class="clear-search-btn" aria-label="Clear search" style="display: none;">✕</button>
            </div>
            
            <div class="filter-section">
                <p id="tags" class="tags-container" role="group" aria-label="Filter by tags"></p>
                <button id="clear-filters" class="clear-filters-btn" aria-label="Clear all filters" style="display: none;">Clear Filters</button>
            </div>
            
            <div id="results-count" class="results-count" aria-live="polite"></div>
        </section>

        <div id="loading-indicator" class="loading-indicator" aria-live="polite" style="display: none;">
            <p>Loading posts...</p>
        </div>

        <div id="error-message" class="error-message" role="alert" style="display: none;"></div>

        <div class="project-grid" role="list" aria-label="Post cards">
        </div>
    </main>

    <footer class="footer" role="contentinfo">
        <div class="footer-icons">
            <a href="https://www.linkedin.com/in/hugh-bill" target="_blank" rel="noopener noreferrer" aria-label="Visit my LinkedIn profile">
                <img src="src/InBug-White.png" alt="LinkedIn Logo" class="footer-logo">
            </a>
            <a href="https://github.com/Salmon-master" target="_blank" rel="noopener noreferrer" aria-label="Visit my GitHub profile">
                <img src="src/github-mark-white.png" alt="GitHub Logo" class="footer-logo">
            </a>
            <a href="mailto:hugh.bill@icloud.com" aria-label="Send me an email">
                <img src="src/icons8-email-96.png" alt="Email icon" class="footer-logo">
            </a>
        </div>
        <p class="footer-copyright">&copy; 2025 <a href="index.html">Hugh Thompson</a>. All rights reserved.</p>
    </footer>
</body>
<script src="main.js"></script>
<script type="module">
    import Project from '/project_class.js';

    // Loading and error states
    const loadingIndicator = document.getElementById('loading-indicator');
    const errorMessage = document.getElementById('error-message');
    const projectGrid = document.querySelector('.project-grid');
    const resultsCount = document.getElementById('results-count');
    const clearSearchBtn = document.getElementById('clear-search');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const searchInput = document.getElementById('search');

    let files = [];
    let filter_list = [];
    let sorted = [];
    let searchTimeout;

    // Show loading state
    function showLoading() {
        loadingIndicator.style.display = 'block';
        errorMessage.style.display = 'none';
        projectGrid.innerHTML = '';
    }

    // Hide loading state
    function hideLoading() {
        loadingIndicator.style.display = 'none';
    }

    // Show error message
    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        hideLoading();
    }

    // Load posts from API
    async function loadProjectsFromAPI() {
        showLoading();
        try {
            const response = await fetch("https://my-website-sooty-kappa.vercel.app/api/projects");
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            files = await response.json();
            console.log('Loaded files:', files);
            
            let projects = files.map(file => {
                return new Project(file.slice(0, -3));
            });
            
            sorted = projects.sort((a, b) => Date.parse(b.meta.date) - Date.parse(a.meta.date));
            hideLoading();
            
            // Generate tag HTML after projects are loaded
            generateTagButtons();
            
            loadProjects();
        } catch (error) {
            console.error('Error loading posts:', error);
            showError('Failed to load posts. Please try again later.');
            files = [];
            sorted = [];
        }
    }
    
    // Generate tag filter buttons
    function generateTagButtons() {
        if (Project.tags && Project.tags.length > 0) {
            let tag_html = "";
            Project.tags.forEach(tag => {
                const isActive = filter_list.includes(tag);
                const activeClass = isActive ? "active_tag" : "";
                const checkmark = isActive ? "  ✖" : "";
                tag_html += `<button type="button" class="tag ${activeClass}" onclick="toggleTag('${tag}')" id="${tag}" aria-label="Filter by ${tag}">${tag}${checkmark}</button>`;
            });
            document.getElementById("tags").innerHTML = tag_html;
        }
    }

    // Debounce function for search
    function debounce(func, wait) {
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(searchTimeout);
                func(...args);
            };
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(later, wait);
        };
    }

    // Update results count
    function updateResultsCount(count, total) {
        if (count === 0) {
            resultsCount.textContent = 'No posts found';
            resultsCount.className = 'results-count no-results';
        } else {
            resultsCount.textContent = `Showing ${count} of ${total} post${total !== 1 ? 's' : ''}`;
            resultsCount.className = 'results-count';
        }
    }

    // Update clear buttons visibility
    function updateClearButtons() {
        if (searchInput.value.trim() || filter_list.length > 0) {
            clearSearchBtn.style.display = searchInput.value.trim() ? 'block' : 'none';
            clearFiltersBtn.style.display = filter_list.length > 0 ? 'block' : 'none';
        } else {
            clearSearchBtn.style.display = 'none';
            clearFiltersBtn.style.display = 'none';
        }
    }

    // Load and display posts
    function loadProjects() {
        const search_term = searchInput.value.toLowerCase().trim();
        let cardshtml = "";
        let visibleCount = 0;

        for (const element of sorted) {
            let tags = null;
            let show = true; // Show by default if no filters
            
            // Get tags from element metadata
            if (element.meta.tags) {
                // Handle both comma-separated and comma+space-separated tags
                tags = element.meta.tags.split(",").map(t => t.trim()).filter(t => t.length > 0);
            }
            
            // Check if the post should be shown based on the tags
            if (filter_list.length > 0) {
                if (tags && tags.length > 0) {
                    // Show post if it has ALL of the selected tags (AND logic)
                    show = filter_list.every(val => tags.includes(val));
                } else {
                    // If post has no tags and filters are active, hide it
                    show = false;
                }
            }

            // Check search term
            if (search_term && show) {
                const term_found = element.meta.title.toLowerCase().includes(search_term) || 
                                 element.meta.description.toLowerCase().includes(search_term);
                show = show && term_found;
            }

            if (show) {
                visibleCount++;
                const tagsHtml = tags && tags.length > 0 
                    ? tags.map(tag => `<button type="button" class="tag card-tag" onclick="event.stopPropagation(); toggleTag('${tag.trim()}');" aria-label="Filter by ${tag.trim()}">${tag.trim()}</button>`).join('')
                    : '';
                
                cardshtml += `
                    <article class="project-card" role="listitem" tabindex="0" 
                        onclick="openProject('${element.meta.id}')"
                        onkeydown="if(event.key === 'Enter' || event.key === ' ') { event.preventDefault(); openProject('${element.meta.id}'); }"
                        aria-label="Post: ${element.meta.title}">
                        <div>
                            <h3>${element.meta.title}</h3>
                            <div class="card-tags-container">${tagsHtml}</div>
                            <h5>${element.meta.date}</h5>
                            <p>${element.meta.description}</p>
                        </div>
                        <img src="${element.meta.img}" alt="${element.meta.title}" loading="lazy">
                    </article>
                `;
            }
        }

        if (cardshtml === "") {
            cardshtml = `<div class="no-results-message"><h2>Sorry, Nothing Matches!</h2><p>Try adjusting your search or filters.</p></div>`;
        }
        
        projectGrid.innerHTML = cardshtml;
        updateResultsCount(visibleCount, sorted.length);
        updateClearButtons();
    }

    // Clear search
    function clearSearch() {
        searchInput.value = '';
        loadProjects();
    }

    // Clear all filters
    function clearAllFilters() {
        filter_list = [];
        updateFilterButtons();
        loadProjects();
    }

    // Toggle tag filter
    function toggleTag(tag) {
        console.log('toggleTag called with:', tag);
        
        // Clean the tag name
        const cleanTag = tag.trim();
        
        // Check if tag is already in filter list
        const isActive = filter_list.includes(cleanTag);
        
        if (isActive) {
            // Remove from filter list
            const index = filter_list.indexOf(cleanTag);
            if (index > -1) {
                filter_list.splice(index, 1);
            }
        } else {
            // Add to filter list
            if (!filter_list.includes(cleanTag)) {
                filter_list.push(cleanTag);
            }
        }
        
        console.log('Filter list after toggle:', filter_list);
        
        // Update all filter buttons to reflect current state
        updateFilterButtons();
        
        // Reload posts
        loadProjects();
    }
    
    // Update all filter button states
    function updateFilterButtons() {
        Project.tags.forEach(tag => {
            const tagElement = document.getElementById(tag);
            if (tagElement) {
                if (filter_list.includes(tag)) {
                    tagElement.classList.add("active_tag");
                    if (!tagElement.textContent.includes('✖')) {
                        tagElement.textContent += "  ✖";
                    }
                } else {
                    tagElement.classList.remove("active_tag");
                    tagElement.textContent = tagElement.textContent.replace('  ✖', '');
                }
            }
        });
    }

    // Open post
    function openProject(id) {
        const params = new URLSearchParams();
        params.append("project_id", id);
        const url = "project_skeleton.html?" + params.toString();
        window.location.href = url;
    }

    // Initialize
    loadProjectsFromAPI();

    // Event listeners
    searchInput.addEventListener('input', debounce(loadProjects, 300));
    searchInput.addEventListener('keyup', (event) => {
        if (event.key === 'Escape') {
            clearSearch();
        }
    });
    
    clearSearchBtn.addEventListener('click', clearSearch);
    clearFiltersBtn.addEventListener('click', clearAllFilters);

    // Expose functions to global scope
    window.openProject = openProject;
    window.toggleTag = toggleTag;

    // Update menu toggle aria-expanded
    const originalOnToggle = window.onToggle;
    window.onToggle = function() {
        const menuToggle = document.getElementById('menu-toggle');
        if (menuToggle) {
            const isExpanded = menuToggle.getAttribute('aria-expanded') === 'true';
            menuToggle.setAttribute('aria-expanded', !isExpanded);
        }
        if (originalOnToggle) {
            originalOnToggle();
        }
    };

</script>

</html>