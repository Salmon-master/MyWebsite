<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="navbar.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=mail" />
    <link rel="stylesheet" href="project-grid.css">
</head>

<body>
    <div class="header">
        <div class="progress-container">
            <div class="progress-bar" id="myBar"></div>
        </div>
    </div>
    <div>

        <div class="navbar">
            <div class="menu-btn" onclick="onToggle()">
                <div class="btn-line"></div>
                <div class="btn-line"></div>
                <div class="btn-line"></div>
            </div>
            <a href="index.html" class="logo menu-item">Hugh Thompson</a>
            <a href="portfolio.html" class="menu-item">Portfolio</a>
            <a href="" class="menu-item">My Services</a>
            <a href="blog.html" class="menu-item">Blog</a>
            <a href="" class="menu-item">Contact</a>
        </div>

        <div class="main-body">
            <h2>Blog</h2>

            <input type="text" id="search" placeholder="Search...">

            <p id="tags"></p>
            <div class="project-grid">


            </div>
        </div>

    </div>
    </div>
</body>
<script src="main.js"></script>
<script type="module">
    import Project from '/project_class.js';

    var files;

    try {
        const response = await fetch('/api/projects');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        files = await response.json();
        console.log('Loaded files:', files);
    } catch (error) {
        console.error('Error loading projects:', error);
        // Fallback: use an empty array or hardcoded list
        files = [];
    }

    let filter_list = [];
    let projects = files.map(file => {
        return new Project(file.slice(0, -3));
    });
    console.log("Projects: ", projects);
    console.log("test: ", projects[0].meta.date);
    console.log("test2: ", Date.parse(projects[0].meta.date));
    let sorted = projects.sort((a, b) => Date.parse(b.meta.date) - Date.parse(a.meta.date));

    function loadProjects() {

        let search_term = document.getElementById("search").value.toLowerCase();
        console.log("Search term: ", search_term);
        let cardshtml = "";

        for (const element of sorted) {
            let tags = null;
            let show = false
            // Get tags from element metadata
            if (element.meta.tags) {
                tags = element.meta.tags ? element.meta.tags.split(", ") : [];
            }
            // Check if the project should be shown based on the tags
            if (tags) {
                show = filter_list.every(val => tags.includes(val))
            }

            if (search_term) {
                let term_found = element.meta.title.toLowerCase().includes(search_term) || element.meta.description.toLowerCase().includes(search_term);
                show = show && term_found;
            }

            if (show == true) {
                cardshtml += `
            <div class="project-card" onclick="openProject('${element.meta.id}')">
                <div>
                    <h3>${element.meta.title}</h3>`
                if (element.meta.tags && element.meta.tags.length > 0) {
                    element.meta.tags.split(",").forEach(tag => {
                        cardshtml += `<span class="tag">${tag}</span>`;
                    });
                }
                cardshtml += `<h5>${element.meta.date}</h5>
                    <p>
                        ${element.meta.description}
                        </p>
                </div>
                <img src="${element.meta.img}" alt="${element.meta.title}">
            </div>
            `;
            }

        }
        if (cardshtml == "") {
            cardshtml = "<h2>Sorry, Nothing Matches!</h2>"
        }
        document.getElementsByClassName('project-grid')[0].innerHTML = cardshtml;
    }

    loadProjects(); // Load all projects initially

    document.getElementById('search').addEventListener('keyup', (event) => {
        loadProjects();
    });

    function openProject(id) {
        console.log("Opening project: ", id);
        var params = new URLSearchParams();
        params.append("project_id", id);
        var url = "project_skeleton.html?" + params.toString();
        var new_window = window.open(url, "_self", `width=${window.innerWidth},height=${window.innerHeight}`);

    }

    function order(tag) {
        if (document.getElementById(tag).classList.contains("active_tag")) {
            console.log("Already ordered by tag: ", tag);
            document.getElementById(tag).classList.remove("active_tag")
            let index = filter_list.indexOf(tag)
            filter_list.splice(index, 1)
            loadProjects()
            let str = document.getElementById(tag).innerHTML
            document.getElementById(tag).innerHTML = str.substring(0, str.length - 3)
        } else {
            console.log("Ordering by tag: ", tag);
            filter_list.push(tag)
            loadProjects(); // Load projects filtered by the selected tag
            document.getElementById(tag).classList.add("active_tag");
            document.getElementById(tag).innerText += "  âœ–"
        }
    }
    // document.getElementById('search').addEventListener('input', loadProjects);

    document.order = order; // Expose the function to the global scope
    window.openProject = openProject; // Expose the function to the global scope
    window.loadProjects = loadProjects; // Expose the function to the global scope
    console.log(Project.tags)
    let tag_html = "";
    Project.tags.forEach(tag => {
        tag_html += `<span class="tag a" onclick="order('${tag}')" id="${tag}">${tag}</span>`;
    });
    document.getElementById("tags").innerHTML = tag_html;



</script>

</html>